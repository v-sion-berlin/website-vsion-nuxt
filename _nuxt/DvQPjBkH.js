import{u as T,a as z,r as E,o as ie,_ as oe,b as se,c as S,d as A,e as N,f as K,n as ae,F as re,g as v,w as q,T as V,t as ce,h as U,i as D,j as H,k as de,l as W,m as J,p as le,q as pe,s as ue,v as Q}from"#entry";import{_ as fe}from"./DlAUqK2U.js";import{loadDatabaseAdapter as P}from"./CfULCBOk.js";import{j as Z,p as he,d as ve,m as k,h as me,c as b}from"./hoZb054c.js";import{r as we}from"./Ci1wg1A_.js";import"./CMP1ebxt.js";import"./DuAV58dt.js";import"./DTPKDRuL.js";const ge={key:0},ye={key:0},xe={id:"__preview_loader"},_e={__name:"ContentPreviewMode",props:{previewToken:{type:String,required:!0},api:{type:String,required:!0},initializePreview:{type:Function,required:!0}},setup(e){const n=e,t=["__nuxt_preview","__preview_enabled"],r=T(),d=z(),i=E(!0),l=E(!1),o=E(!1),c=E("");let a;const u=async()=>{U("previewToken").value="",window.sessionStorage.removeItem("previewToken"),window.sessionStorage.removeItem("previewAPI"),await d.replace({query:{preview:void 0}}),window.location.reload()},y=async _=>{await n.initializePreview(_),U("previewToken").value&&(o.value=!0,await d.replace({query:{}}),r.callHook("nuxt-content:preview:ready"),window.parent&&window.self!==window.parent&&a.disconnect())};return ie(async()=>{a=(await oe(()=>import("./j843apyr.js"),[],import.meta.url)).connect(`${n.api}/preview`,{transports:["websocket","polling"],auth:{token:n.previewToken}});let s;a.on("connect",()=>{s=setTimeout(()=>{o.value||(s=setTimeout(()=>{c.value="Preview sync timed out",o.value=!1},3e4),a.emit("draft:requestSync"))},3e4)});const p=()=>{s&&(clearTimeout(s),s=null)};a.on("draft:sync",async f=>{if(p(),!f){try{a.once("draft:ready",()=>{a.emit("draft:requestSync")}),await $fetch("api/projects/preview/sync",{baseURL:n.api,method:"POST",params:{token:n.previewToken}})}catch(h){switch(p(),h.response.status){case 404:c.value="Preview draft not found",o.value=!1;break;default:c.value="An error occurred while syncing preview",o.value=!1}}return}y(f)}),a.on("draft:unauthorized",()=>{p(),c.value="Unauthorized preview",o.value=!1}),a.on("disconnect",()=>{p()}),document.body.classList.add(...t)}),se(()=>{document.body.classList.remove(...t)}),(_,s)=>(A(),S("div",null,[i.value?(A(),S("div",{key:0,id:"__nuxt_preview",class:ae({__preview_ready:o.value,__preview_refreshing:l.value})},[o.value?(A(),S(re,{key:0},[s[0]||(s[0]=v("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[v("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),s[1]||(s[1]=v("span",null,"Preview enabled",-1)),v("button",{onClick:u}," Close ")],64)):N("",!0)],2)):N("",!0),K(V,{name:"preview-loading"},{default:q(()=>[i.value&&!o.value&&!c.value?(A(),S("div",ge,[s[4]||(s[4]=v("div",{id:"__preview_background"},null,-1)),v("div",{id:"__preview_loader"},[s[2]||(s[2]=v("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[v("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),s[3]||(s[3]=v("p",null,"Initializing the preview...",-1)),v("button",{onClick:u}," Cancel ")])])):N("",!0)]),_:1}),K(V,{name:"preview-loading"},{default:q(()=>[c.value?(A(),S("div",ye,[s[5]||(s[5]=v("div",{id:"__preview_background"},null,-1)),v("div",xe,[v("p",null,ce(c.value),1),v("button",{onClick:u}," Exit preview ")])])):N("",!0)]),_:1})]))}},Ce=fe(_e,[["__scopeId","data-v-d2816b4d"]]),g={appConfig:"app.config.ts",appConfigV4:"app/app.config.ts",nuxtConfig:"nuxt.config.ts"};function I(e){return e?.startsWith("content/")?e.split("/").slice(1).join("/"):D(e)}function x(e,n=!1){return e&&(n?H(e.replace(/\/\d+\./,"/")):D(e.replace(/^\d+\./,"")))}function $(e){const n=I(e);return Z(ve(n),he(n).name)}function Pe(e=[],n,t){const r=[...n||[]],d=[...t||[]],i=JSON.parse(JSON.stringify(e));for(const o of r)if(o.new)i.push({path:o.path,parsed:o.parsed});else if(o.oldPath)if(d.splice(d.findIndex(a=>a.path===o.oldPath),1),r.find(a=>a.path===o.oldPath))i.push({path:o.path,parsed:o.parsed});else{const a=i.find(u=>u.path===o.oldPath);a&&(a.path=o.path,o.parsed?a.parsed=o.parsed:o.pathMeta&&["_file","_path","_id","_locale"].forEach(u=>{a.parsed[u]=o.pathMeta[u]}))}else{const c=i.find(a=>a.path===o.path);c?Object.assign(c,{path:o.path,parsed:o.parsed}):i.push({path:o.path,parsed:o.parsed})}for(const o of d)i.splice(i.findIndex(c=>c.path===o.path),1);const l=new Intl.Collator(void 0,{numeric:!0});return i.sort((o,c)=>l.compare(o.path,c.path)),i}const ke=de((e,n,t)=>{if(Array.isArray(e[n])&&Array.isArray(t))return e[n]=t,!0}),be=e=>{let n;return t=>(n||(n=e()),n)};function G(e,n){for(const t in e){const r=n[t];t in n||delete e[t],r!==null&&typeof r=="object"&&G(e[t],n[t])}}function X(e,n){for(const t in n){const r=n[t];if(r==="_DELETED_"){delete e[t];continue}r!==null&&typeof r=="object"?Array.isArray(r)&&Array.isArray(e[t])?e[t]=r:(e[t]=e[t]||{},X(e[t],r)):e[t]=r}}function Y(e){const[n,...t]=e.include.includes("*")?e.include.split("*"):["",e.include];return{fixed:n||"",dynamic:"*"+t.join("*")}}const ee=(e,n,t)=>{const{fixed:r}=Y(t);if(!e.parsed)return;const d=x(r||""),i=x(t?.prefix||"",!0),l=e.parsed._path.substring(d.length),o=Z(i,l),c={id:e.parsed._id,stem:e.parsed._stem,meta:{},extension:e.parsed._extension,path:o},a=n.schema.definitions[n.name].properties;return Object.keys(e.parsed).forEach(u=>{u in a?c[u]=e.parsed[u]:c.meta[u]=e.parsed[u]}),c};function Se(e){const n=Object.values(e.definitions)[0]?.properties||{},t=new Set([n.id?"id":void 0,n.title?"title":void 0,...Object.keys(n).sort()].filter(Boolean));return Array.from(t)}const R=(e,n)=>{let t;return{collection:Object.values(n).find(d=>{if(!d.source||d.source.length===0)return;const i=I(e);return(i==="/"?["index.yml","index.yaml","index.md","index.json"]:[i]).some(o=>(t=d.source.find(c=>{const a=k(o,c.include),u=c.exclude?.some(y=>k(o,y));return a&&!u}),t))}),matchedSource:t}},Ae=(e,n)=>{let t;return{collection:Object.values(n).find(d=>{if(!(!d.source||d.source.length===0))return t=d.source.find(i=>{if(!i.prefix)return;const l=x(i.prefix,!0);if(!e.startsWith(l))return;if(e==="/"){const p=["index.yml","index.yaml","index.md","index.json"];return(e==="/"?p:p.map(h=>D(W(l,h)))).some(h=>{const m=k(h,x(i.include)),w=i.exclude?.some(C=>k(h,x(C)));return m&&!w})}const{fixed:o}=Y(i),c=x(o||""),a=e.substring(l.length),u=W(c,a),y=p=>p.replace(/\.[^/.]+$/,""),_=k(u,y(x(i.include))),s=i.exclude?.some(p=>k(u,y(x(p))));return _&&!s}),t}),matchedSource:t}};function te(e,n){const t=Ne(e,n);let r=0;return`INSERT INTO ${e.tableName} VALUES (${"?, ".repeat(t.length).slice(0,-2)})`.replace(/\?/g,()=>t[r++])}function Ee(e,n,t){const r=ne(e,n),d=te(e,t);return`${r}; ${d}`}function ne(e,n){return`DELETE FROM ${e.tableName} WHERE stem = '${n}';`}function B(e,n,t){return`SELECT * FROM ${e.tableName} WHERE ${n} = '${t}';`}function Ne(e,n){const t=[],r=e.schema.definitions[e.name].properties;return Se(e.schema).forEach(i=>{const l=r[i],o=e.fields[i],c=l?.default!==void 0?l.default:"NULL",a=typeof n[i]<"u"?n[i]:c;o==="json"?t.push(`'${JSON.stringify(a).replace(/'/g,"''")}'`):o==="string"||["string","enum"].includes(l.type)?["data","datetime"].includes(l.format)?t.push(a!=="NULL"?`'${new Date(a).toISOString()}'`:c):t.push(`'${String(a).replace(/\n/g,"\\n").replace(/'/g,"''")}'`):o==="boolean"?t.push(a!=="NULL"?!!a:a):t.push(a)}),t.push(`'${me(t)}'`),t}const Re=["https://nuxt.studio","https://dev.nuxt.studio"],M=E(!1),j=be(()=>JSON.parse(JSON.stringify(Q()))),Ie=async e=>{const n=Pe(e.files,e.additions,e.deletions),t=n.filter(d=>![g.appConfig,g.appConfigV4,g.nuxtConfig].includes(d.path));for(const d of Object.values(b))await P(d.name).exec(d.tableDefinition);for(const d of t)await Te(b,d);const r=n.find(d=>[g.appConfig,g.appConfigV4].includes(d.path));r&&O(r.parsed),we(),M.value=!0},Te=async(e,n)=>{const{collection:t,matchedSource:r}=R(n.path,e);if(!t||!r){console.warn(`Content Preview: collection not found for file: ${n.path}, skipping insertion.`);return}const d=P(t.name),i=ee(n,t,r),l=te(t,i);await d.exec(l)},O=e=>{const n=T(),t=ue(n,Q);X(t,ke(e||{},j)),e||G(t,j)};function We(){const e=J().public.preview||{},n=window.sessionStorage.getItem("previewToken"),t=document.createElement("div");t.id="__nuxt_preview_wrapper",document.body.appendChild(t),le(Ce,{previewToken:n,api:window.sessionStorage.getItem("previewAPI")||e?.api,initializePreview:Ie}).mount(t)}function Be(){const e=T(),n=J().public.preview;if(!window.parent||window.self===window.parent)return;const t=z(),r=pe();window.addEventListener("keydown",i=>{(i.metaKey||i.ctrlKey||i.altKey||i.shiftKey)&&window.parent.postMessage({type:"nuxt-content:preview:keydown",payload:{key:i.key,metaKey:i.metaKey,ctrlKey:i.ctrlKey,shiftKey:i.shiftKey,altKey:i.altKey}},"*")}),window.addEventListener("message",async i=>{if(!M.value)return;const l=n?.iframeMessagingAllowedOrigins?.split(",").map(s=>s.trim())||[];if(!["http://localhost:3000",...Re,...l].includes(i.origin))return;const{type:o,payload:c={},navigate:a}=i.data||{};switch(o){case"nuxt-content:editor:file-selected":{await u(c.path);break}case"nuxt-content:editor:file-changed":case"nuxt-content:editor:media-changed":{const{additions:s=[],deletions:p=[]}=c;for(const f of s)await y(f,a);for(const f of p)await _(f.path);Le();break}case"nuxt-content:config:file-changed":{const{additions:s=[],deletions:p=[]}=c,f=s.find(m=>[g.appConfig,g.appConfigV4].includes(m.path));f&&O(f?.parsed),p.find(m=>[g.appConfig,g.appConfigV4].includes(m.path))&&O(void 0)}}async function u(s){if(!s)return;const{collection:p}=R(I(s),b);if(!p){console.warn(`Content Preview: collection not found for file: ${s}, skipping navigation.`);return}if(p.type!=="page")return;const f=P(p.name),h=$(s),m=B(p,"stem",h),w=await f.first(m);if(!w||!w.path)return;const C=t.resolve(w.path);!C||!C.matched||C.matched.length===0||w.path!==r.path&&t.push(w.path)}async function y(s,p){const{collection:f,matchedSource:h}=R(s.path,b);if(!f||!h){console.warn(`Content Preview: collection not found for file: ${s.path}, skipping update.`);return}const m=$(s.path),w=ee({path:s.path,parsed:s.parsed},f,h),C=Ee(f,m,w);if(await P(f.name).exec(C),f.type!=="page"||!s.pathRoute)return;const L=H(s.pathRoute);if(p&&L!==r.path){const F=t.resolve(L);if(!F||!F.matched||F.matched.length===0)return;t.push(L)}}async function _(s){const{collection:p}=R(I(s),b);if(!p){console.warn(`Content Preview: collection not found for file: ${s}, skipping deletion.`);return}const f=$(s),h=ne(p,f);await P(p.name).exec(h)}});async function d(){if(!M.value)return;const i=r.path,{collection:l}=Ae(i,b);if(!l||l.type!=="page"){window.sendNavigateMessageInPreview(i,!1);return}const o=P(l.name),c=B(l,"path",i),a=await o.first(c);window.sendNavigateMessageInPreview(i,!!a?.path)}e.hook("page:finish",()=>{d()}),e.hook("nuxt-content:preview:ready",()=>{window.parent.postMessage({type:"nuxt-content:preview:ready"},"*")}),window.sendNavigateMessageInPreview=(i,l)=>{window.parent.postMessage({type:"nuxt-content:preview:navigate",payload:{path:i,navigate:l}},"*")}}async function Le(){await T().hooks.callHookParallel("app:data:refresh")}export{Be as initIframeCommunication,We as mountPreviewUI};
